// script.js.template
// Placeholders: __EMAILJS_USER_ID__, __EMAILJS_SERVICE_ID__, __EMAILJS_TEMPLATE_ID__, __VAPI_ASSISTANT_ID__, __VAPI_PUBLIC_KEY__

/* ========== EmailJS configuration ========== */
const EMAILJS_USER_ID = "__EMAILJS_USER_ID__";
const EMAILJS_SERVICE_ID = "__EMAILJS_SERVICE_ID__";
const EMAILJS_TEMPLATE_ID = "__EMAILJS_TEMPLATE_ID__";

/* ========== Load EmailJS SDK dynamically ========== */
(function loadEmailJSSDK() {
  const s = document.createElement("script");
  s.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
  s.onload = function () {
    if (window.emailjs && typeof emailjs.init === "function") {
      emailjs.init(EMAILJS_USER_ID);
      console.info("‚úÖ EmailJS initialized");
    }
  };
  s.onerror = () => console.warn("‚ùå EmailJS SDK failed to load");
  document.head.appendChild(s);
})();

/* ========== Send booking email ========== */
function sendBookingEmail({ name, address, urgency }) {
  return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
    customer_name: name,
    customer_address: address,
    customer_urgency: urgency,
    submitted_at: new Date().toLocaleString(),
  });
}

/* ============================================================
    ‚úÖ VAPI AI VOICE AGENT (NO BACKEND)
   ============================================================ */

const VAPI_ASSISTANT_ID = "__VAPI_ASSISTANT_ID__";
const VAPI_PUBLIC_KEY = "__VAPI_PUBLIC_KEY__";

// ‚úÖ Ensure Vapi SDK is loaded
if (!window.Vapi) {
  console.error("‚ùå Vapi SDK is not loaded. Check index.html script order.");
}

const vapiClient = new Vapi.Client({
  apiKey: VAPI_PUBLIC_KEY,
});

/* ‚úÖ Start voice agent */
function startVapiAgent() {
  console.log("üé§ Starting VAPI conversation...");

  vapiClient.startConversation({
    assistantId: VAPI_ASSISTANT_ID,

    onMessage: (msg) => {
      console.log("üì© VAPI Message:", msg);

      // ‚úÖ Booking complete event from VAPI
      if (msg.type === "event" && msg.name === "booking_complete") {
        const { name, address, urgency } = msg.data;

        sendBookingEmail({ name, address, urgency })
          .then(() => {
            document.getElementById("booking-status").textContent =
              "‚úÖ Booking confirmed!";
            document.getElementById("booking-status-2").textContent =
              "‚úÖ Owner notified via email.";
          })
          .catch(() => {
            document.getElementById("booking-status").textContent =
              "‚ùå Error sending email.";
          });
      }
    },
  });
}

/* ‚úÖ Attach to booking buttons */
const btn1 = document.getElementById("book-btn");
if (btn1) btn1.addEventListener("click", startVapiAgent);

const btn2 = document.getElementById("book-btn-2");
if (btn2) btn2.addEventListener("click", startVapiAgent);

/* ============================================================
    ‚úÖ OPTIONAL FALLBACK BOOKING FORM (if exists)
   ============================================================ */

// Modal open/close only if modal exists
const modal = document.getElementById("agent-modal");
const modalClose = document.getElementById("modal-close");

function openAgentModal() {
  if (modal) modal.setAttribute("aria-hidden", "false");
}

function closeAgentModal() {
  if (modal) modal.setAttribute("aria-hidden", "true");
}

if (modalClose) modalClose.addEventListener("click", closeAgentModal);

// Fallback form submission (only if form elements exist)
const demoSubmit = document.getElementById("demo-submit");
if (demoSubmit) {
  demoSubmit.onclick = function () {
    const name = document.getElementById("demo-name")?.value.trim();
    const address = document.getElementById("demo-address")?.value.trim();
    const urgency = document.getElementById("demo-urgency")?.value;

    if (!name || !address) {
      alert("Please enter name and address.");
      return;
    }

    sendBookingEmail({ name, address, urgency })
      .then(() => {
        document.getElementById("booking-status").textContent =
          "‚úÖ Booking confirmed!";
        document.getElementById("booking-status-2").textContent =
          "‚úÖ Owner notified via email.";
        closeAgentModal();
      })
      .catch(() => {
        const res = document.getElementById("modal-result");
        if (res) res.textContent = "‚ùå Error: Could not notify owner.";
      });
  };
}
