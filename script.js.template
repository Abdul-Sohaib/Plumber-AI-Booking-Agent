// script.js.template
// Placeholders: __EMAILJS_USER_ID__, __EMAILJS_SERVICE_ID__, __EMAILJS_TEMPLATE_ID__, __VAPI_ASSISTANT_ID__, __VAPI_PUBLIC_KEY__

/* ========== EmailJS configuration ========== */
const EMAILJS_USER_ID = "__EMAILJS_USER_ID__";
const EMAILJS_SERVICE_ID = "__EMAILJS_SERVICE_ID__";
const EMAILJS_TEMPLATE_ID = "__EMAILJS_TEMPLATE_ID__";

/* ========== Load EmailJS SDK dynamically ========== */
(function loadEmailJSSDK() {
  const s = document.createElement("script");
  s.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
  s.onload = function () {
    if (window.emailjs && typeof emailjs.init === "function") {
      emailjs.init(EMAILJS_USER_ID);
      console.info("EmailJS initialized");
    }
  };
  s.onerror = () => console.warn("EmailJS SDK failed to load");
  document.head.appendChild(s);
})();

/* ========== Helper: send booking email via EmailJS ========== */
function sendBookingEmail({ name, address, urgency }) {
  return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
    customer_name: name,
    customer_address: address,
    customer_urgency: urgency,
    submitted_at: new Date().toLocaleString(),
  });
}

/* ============================================================
    ‚úÖ VAPI AI VOICE AGENT INTEGRATION (NO BACKEND NEEDED)
   ============================================================ */

// üîë Filled by Docker at runtime
const VAPI_ASSISTANT_ID = "__VAPI_ASSISTANT_ID__";
const VAPI_PUBLIC_KEY = "__VAPI_PUBLIC_KEY__";

// Initialize VAPI client
const vapiClient = new Vapi.Client({
  apiKey: VAPI_PUBLIC_KEY,
});

/* ‚úÖ When user clicks BOOK ‚Äì start voice agent conversation */
function startVapiAgent() {
  vapiClient.startConversation({
    assistantId: VAPI_ASSISTANT_ID,

    onMessage: (msg) => {
      console.log("VAPI Message:", msg);

      // ‚úÖ When agent completes booking
      if (msg.type === "event" && msg.name === "booking_complete") {
        const { name, address, urgency } = msg.data;

        // ‚úÖ send via EmailJS
        sendBookingEmail({ name, address, urgency })
          .then(() => {
            document.getElementById("booking-status").textContent =
              "‚úÖ Booking confirmed!";
            document.getElementById("booking-status-2").textContent =
              "Owner notified via email.";
          })
          .catch(() => {
            document.getElementById("booking-status").textContent =
              "‚ùå Error notifying owner.";
          });
      }
    },
  });
}

/* ‚úÖ Bind UI Buttons */
document.getElementById("book-btn").addEventListener("click", startVapiAgent);
document.getElementById("book-btn-2").addEventListener("click", startVapiAgent);

/* ============================================================
    ‚úÖ Fallback Modal (Manual Typed Booking)
    Also sends EmailJS if user prefers typing.
   ============================================================ */

function openAgentModal() {
  document.getElementById("agent-modal").setAttribute("aria-hidden", "false");
}

function closeAgentModal() {
  document.getElementById("agent-modal").setAttribute("aria-hidden", "true");
}

document.getElementById("modal-close").addEventListener("click", closeAgentModal);

document.getElementById("demo-submit").onclick = function () {
  const name = document.getElementById("demo-name").value.trim();
  const address = document.getElementById("demo-address").value.trim();
  const urgency = document.getElementById("demo-urgency").value;

  if (!name || !address) {
    alert("Please enter name and address.");
    return;
  }

  sendBookingEmail({ name, address, urgency })
    .then(() => {
      document.getElementById("booking-status").textContent =
        "‚úÖ Booking confirmed!";
      document.getElementById("booking-status-2").textContent =
        "Owner notified via email.";
      closeAgentModal();
    })
    .catch(() => {
      document.getElementById("modal-result").textContent =
        "‚ùå Error: Could not notify owner. Please try again.";
    });
};
